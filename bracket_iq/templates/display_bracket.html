<!-- display_bracket.html -->
{% extends "base_generic.html" %}
{% load bracket_filters %}

{% block content %}
<div class="container mt-4">
    <h1>{{ bracket.name }}</h1>
    <p>Tournament: {{ bracket.tournament.name }}</p>

    {% for round_value, predictions in predictions_by_round.items %}
    <div class="card mb-4">
        <div class="card-header">
            <h3>{{ round_names|get_item:round_value }}</h3>
        </div>
        <div class="card-body">
            {% for prediction_data in predictions %}
                {% with game=prediction_data.game prediction=prediction_data.prediction bracket_game=prediction_data.bracket_game %}
                <div class="game-prediction mb-3">
                    <h4>Game {{ game.game_number }}</h4>
                    <div class="teams">
                        <div class="team {% if prediction and prediction.predicted_winner == bracket_game.team1 %}selected{% endif %}">
                            {{ bracket_game.team1.name|default:"TBD" }}
                        </div>
                        <div class="team {% if prediction and prediction.predicted_winner == bracket_game.team2 %}selected{% endif %}">
                            {{ bracket_game.team2.name|default:"TBD" }}
                        </div>
                    </div>
                    {% if prediction %}
                    <form method="post" action="{% url 'update_prediction' prediction_id=prediction.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="game" value="{{ game.id }}">
                        <input type="hidden" name="winner" value="{{ prediction.predicted_winner.id }}">
                        <button type="submit" class="btn btn-primary">Update Prediction</button>
                    </form>
                    {% else %}
                    <form method="post" action="{% url 'create_prediction' %}">
                        {% csrf_token %}
                        <input type="hidden" name="bracket" value="{{ bracket.id }}">
                        <input type="hidden" name="game" value="{{ game.id }}">
                        <div class="btn-group" role="group">
                            <button type="submit" name="winner" value="{{ bracket_game.team1.id }}" class="btn btn-outline-primary" {% if not bracket_game.team1 %}disabled{% endif %}>Pick {{ bracket_game.team1.name|default:"TBD" }}</button>
                            <button type="submit" name="winner" value="{{ bracket_game.team2.id }}" class="btn btn-outline-primary" {% if not bracket_game.team2 %}disabled{% endif %}>Pick {{ bracket_game.team2.name|default:"TBD" }}</button>
                        </div>
                    </form>
                    {% endif %}
                </div>
                {% endwith %}
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<div class="bracket-actions">
    <form method="post" action="{% url 'delete_bracket' bracket_id=bracket.id %}" class="delete-form">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger">Delete Bracket</button>
    </form>
</div>

<style>
.bracket-container {
    display: flex;
    flex-wrap: wrap;
    gap: 2rem;
    padding: 1rem;
}

.round {
    flex: 1;
    min-width: 300px;
}

.games {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.game-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1rem;
    background: white;
}

.game-header {
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.teams {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.team {
    padding: 0.5rem;
    border: 1px solid #eee;
    border-radius: 4px;
}

.team.selected {
    background-color: #e3f2fd;
    border-color: #2196f3;
}

.vs {
    text-align: center;
    font-weight: bold;
    color: #666;
}

.prediction-form {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #eee;
}

.prediction-controls {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.bracket-actions {
    margin-top: 2rem;
    text-align: center;
}

.btn {
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
}

.btn-primary {
    background: #2196f3;
    color: white;
    border: none;
}

.btn-outline-primary {
    background: white;
    color: #2196f3;
    border: 1px solid #2196f3;
}

.btn-outline-primary:hover {
    background: #2196f3;
    color: white;
}

.btn-outline-primary:disabled {
    background: #f5f5f5;
    color: #999;
    border-color: #ddd;
    cursor: not-allowed;
    opacity: 0.7;
}

.btn-outline-primary:disabled:hover {
    background: #f5f5f5;
    color: #999;
    border-color: #ddd;
}

.btn-danger {
    background: #f44336;
    color: white;
    border: none;
}

.btn-group {
    display: flex;
    gap: 0.5rem;
}
</style>
{% endblock %}